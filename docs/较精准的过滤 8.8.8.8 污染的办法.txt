当在国内使用 8.8.8.8 解析域名时，可能会接收到多条解析结果，其中只有一条是正确的结果，其他都是污染的返回。
本文猜想一种过滤污染的办法，并进行简单的验证。

### 概述

谷歌 DNS 服务支持 ECS (edns-client-subnet)，当我们在解析请求中添加子网时，
谷歌 DNS 服务器一般会原样返回此子网，即使它没有返回子网，在返回包中也会带有一个空的 OPT RR
 (参考 [Extension Mechanisms for DNS (RFC6891)])。而污染的返回结果中并不会带有 OPT RR。
过滤污染即可基于此原理，只要发送带有 ECS 的请求给 8.8.8.8 服务，然后过滤掉无 OPT RR 的结果即可。

### 猜想的验证

使用 [CleanDNS] 进行验证。国内地址使用 203.208.32.0/24 (北京)，国外地址使用 218.189.25.0/24 (香港)。

启动 [CleanDNS] 的命令如下：

    CleanDNS -l 203.208.32.0/24 -f 218.189.25.0/24 -s 8.8.8.8 -m -p 55555 -vvv

返回结果的说明如下图。

[![返回结果的说明](a1.jpg)]


当我们使用 dig 请求域名时，CleanDNS 将打印出如下的结果。

dig 命令：

    dig +time=20 www.google.com @127.0.0.1 -p 55555

CleanDNS 结果（节选）：

    request www.google.com. from 127.0.0.1:64989
    
    send msg to '8.8.8.8:53' with '203.208.32.0/24'
    
    send msg to '8.8.8.8:53' with '218.189.25.0/24'
    
    recv response www.google.com. from 8.8.8.8:53 (china): 74.125.203.106, 74.125.203.103, 74.125.203.99, 74.125.203.147, 74.125.203.105, 74.125.203.104
    response msg:
    <<< MSG START >>>
    ID: 0x21f8, FLAGS: 0x8180, QDCOUNT: 0x1, ANCOUNT: 0x6, NSCOUNT: 0x0, ARCOUNT: 0x1
    QNAME: www.google.com., QTYPE: 0x1 (A), QCLASS: 0x1 (IN)
    NAME: www.google.com., TYPE: 0x1 (A), CLASS: 0x1 (IN), TTL: 0x110, RDLEN: 0x4
    IPv4: 74.125.203.106
    NAME: www.google.com., TYPE: 0x1 (A), CLASS: 0x1 (IN), TTL: 0x110, RDLEN: 0x4
    IPv4: 74.125.203.103
    NAME: www.google.com., TYPE: 0x1 (A), CLASS: 0x1 (IN), TTL: 0x110, RDLEN: 0x4
    IPv4: 74.125.203.99
    NAME: www.google.com., TYPE: 0x1 (A), CLASS: 0x1 (IN), TTL: 0x110, RDLEN: 0x4
    IPv4: 74.125.203.147
    NAME: www.google.com., TYPE: 0x1 (A), CLASS: 0x1 (IN), TTL: 0x110, RDLEN: 0x4
    IPv4: 74.125.203.105
    NAME: www.google.com., TYPE: 0x1 (A), CLASS: 0x1 (IN), TTL: 0x110, RDLEN: 0x4
    IPv4: 74.125.203.104
    NAME: , TYPE: 0x29 (OPT), PAYLOAD: 0x200, RCODE: 0x0, VERSION: 0x0, Z: 0x0, RDLEN: 0xb
    OPTCOUNT: 0x1
    OPT-CODE: 0x8, OPT-LEN: 0x7, OPT-DATA:
    ECS 203.208.32.0/24 SCOPE 26
    <<< MSG END >>>
    
    recv response www.google.com. from 8.8.8.8:53 (china): 31.13.69.129
    response msg:
    <<< MSG START >>>
    ID: 0x21f8, FLAGS: 0x8180, QDCOUNT: 0x1, ANCOUNT: 0x1, NSCOUNT: 0x0, ARCOUNT: 0x0
    QNAME: www.google.com., QTYPE: 0x1 (A), QCLASS: 0x1 (IN)
    NAME: www.google.com., TYPE: 0x1 (A), CLASS: 0x1 (IN), TTL: 0xc9, RDLEN: 0x4
    IPv4: 31.13.69.129
    <<< MSG END >>>
    
    handle_remote_sock_recv_nsmsg: drop polluted msg
    
    
    recv response www.google.com. from 8.8.8.8:53 (china): (null)
    response msg:
    <<< MSG START >>>
    ID: 0x21f8, FLAGS: 0x8180, QDCOUNT: 0x1, ANCOUNT: 0x1, NSCOUNT: 0x0, ARCOUNT: 0x0
    QNAME: www.google.com., QTYPE: 0x1 (A), QCLASS: 0x1 (IN)
    NAME: , TYPE: 0x29 (OPT), PAYLOAD: 0x400, RCODE: 0x0, VERSION: 0x0, Z: 0x0, RDLEN: 0x17
    OPTCOUNT: 0x2
    OPT-CODE: 0xa, OPT-LEN: 0x8, OPT-DATA:
    0000: b3 55 e9 4e 7b 56 e8 1f  ?U?N{V??
    OPT-CODE: 0x8, OPT-LEN: 0x7, OPT-DATA:
    ECS 203.208.32.0/24 SCOPE 0
    <<< MSG END >>>
    
    handle_remote_sock_recv_nsmsg: drop polluted msg
    
    
    recv response www.google.com. from 8.8.8.8:53 (foreign): 31.13.97.248
    response msg:
    <<< MSG START >>>
    ID: 0x2dbd, FLAGS: 0x8180, QDCOUNT: 0x1, ANCOUNT: 0x1, NSCOUNT: 0x0, ARCOUNT: 0x0
    QNAME: www.google.com., QTYPE: 0x1 (A), QCLASS: 0x1 (IN)
    NAME: www.google.com., TYPE: 0x1 (A), CLASS: 0x1 (IN), TTL: 0x9d, RDLEN: 0x4
    IPv4: 31.13.97.248
    <<< MSG END >>>
    
    handle_remote_sock_recv_nsmsg: drop polluted msg
    
    
    recv response www.google.com. from 8.8.8.8:53 (foreign): 216.58.200.68
    response msg:
    <<< MSG START >>>
    ID: 0x21f9, FLAGS: 0x8180, QDCOUNT: 0x1, ANCOUNT: 0x1, NSCOUNT: 0x0, ARCOUNT: 0x1
    QNAME: www.google.com., QTYPE: 0x1 (A), QCLASS: 0x1 (IN)
    NAME: www.google.com., TYPE: 0x1 (A), CLASS: 0x1 (IN), TTL: 0xe8, RDLEN: 0x4
    IPv4: 216.58.200.68
    NAME: , TYPE: 0x29 (OPT), PAYLOAD: 0x200, RCODE: 0x0, VERSION: 0x0, Z: 0x0, RDLEN: 0xb
    OPTCOUNT: 0x1
    OPT-CODE: 0x8, OPT-LEN: 0x7, OPT-DATA:
    ECS 218.189.25.0/24 SCOPE 24
    <<< MSG END >>>

分析结果可发现，ARCOUNT 为 0 的全都是被污染的结果。


[CleanDNS]:  https://github.com/GangZhuo/CleanDNS
[Extension Mechanisms for DNS (RFC6891)]:  https://tools.ietf.org/rfc/rfc6891.txt
